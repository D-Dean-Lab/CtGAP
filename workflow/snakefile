import sys
from pathlib import Path
from rich import print as pprint

configfile: "config/config.yaml"
include: "rules/common.smk"

INDIR = Path(config["indir"])
OUTDIR = Path(config["outdir"])
KRAKENDB = Path(config["krakenDB"])
HUMANREF = Path(config["homoReference"])
ADAPTERS = Path(config["adapters"])
OMPABLASTDB = Path(config["ompaBlastDB"])
SCAFFOLDREF = Path(config["scaffoldReference"])
MLSTDBLOC = Path(config["mlstDBLoc"])
SAMPLESHEET = Path(config['sample_sheet'])
MODE = config['mode'] 

if config["reference"] == "plurality":
	CTREF = Path("resources/ctReferences/ct_plurality_consensus.fasta")
elif config["reference"] == "reference_24":
	CTREF = Path("resources/ctReferences/ct_references_24.fasta")
else:
	CTREF = Path(f"resources/ctReferences/{config['reference']}")

# get samples
SAMPLE_NAME, PAIR = glob_wildcards(INDIR / "{sample_name}_{pair}.fastq.gz")
SAMPLES = set(SAMPLE_NAME)
# dictReads = parseSamples(SAMPLESHEET)
# SAMPLES = list(dictReads.keys())
if not SAMPLES:
	pprint("[yellow]No input samples were detected. Check the files are named properly: {sample_name}_{pair}[/yellow]")
	sys.exit()

rule all:
	input:
		# denovo
		# expand(OUTDIR / "status" / "mlst.{sample}.txt", sample = SAMPLES),
		# OUTDIR / "status" / "collate.blast.txt",
		# ref-denovo
		expand(OUTDIR / "status" / "ref-denovo.mlst.{sample}.txt", sample = SAMPLES),
		expand(OUTDIR / "status" / "ref-denovo.blastn.{sample}.txt", sample = SAMPLES),
		
		# trim and qc
		# expand(OUTDIR / "status" / "trim.{sample}.txt", sample = SAMPLES),
		# expand(OUTDIR / "status" / "scrub.{sample}.txt", sample = SAMPLES),
		# expand(OUTDIR / "status" / "trim.scrub.{sample}.txt", sample = SAMPLES),

		# # denovo
		# expand(OUTDIR / "status" / "shovill.{sample}.txt", sample = SAMPLES),
		# expand(OUTDIR / "status" / "blastn.{sample}.txt", sample = SAMPLES),
		# expand(OUTDIR / "status" / "scaffold.{sample}.txt", sample = SAMPLES),
		
		# alignment 
		#expand(OUTDIR / "status" / "aligned.{sample}.txt", sample = SAMPLES),

		# collation
		#OUTDIR / "qc" / "multiqc_report.html",
		#OUTDIR / "status" / "collage.coverage.txt"

# common modules
include: "rules/1-trim.smk"
include: "rules/2-scrub.smk"
include: "rules/3-qc.smk"

# modes module
if config['mode'] == 'denovo':
	include: "rules/4-assemble.smk"
elif config['mode'] == 'ref-denovo':
	include: "rules/5-align.smk"
elif config['mode'] == 'both':
	include: "rules/4-assemble.smk"
	include: "rules/5-align.smk"

# analysis module
include: "rules/collate.smk"
